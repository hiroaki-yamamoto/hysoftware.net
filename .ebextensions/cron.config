files:
  "/etc/cron.d/backup":
    mode: "000644"
    owner: root
    group: root
    content: |
      00 0 * * * root run-parts /opt/cron/backup
  "/otp/cron/backup":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/sh -e
      . /opt/python/current/env
      . /opt/python/run/venv/bin/activate
      curDate=$(date -Iseconds)
      python /opt/python/current/app/manage.py \
        dumpdata -o /tmp/db-${curDate} --format json
      deactivate
      aws s3 cp /tmp/db-backup-${curDate}.json s3://hysoft-dump
      rm /tmp/db-${curDate}.json
commands:
  01_remove_old_cron:
    command: "rm -f /etc/cron.d/*.bak"
  02_dump_backup_db:
    command: /otp/cron/backup
